<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - {{businessName}}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color, #4CAF50) 0%, #45a049 100%);
            color: white;
            padding: 30px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .refresh-info {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 5px solid var(--primary-color, #4CAF50);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: var(--primary-color, #4CAF50);
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-change {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 20px;
            margin-top: 10px;
        }
        
        .stat-change.positive {
            background: #d4edda;
            color: #155724;
        }
        
        .stat-change.negative {
            background: #f8d7da;
            color: #721c24;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }
        
        .chart-card h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.4em;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .reviews-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 40px;
        }
        
        .reviews-header {
            background: #34495e;
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reviews-header h3 {
            font-size: 1.5em;
            margin: 0;
        }
        
        .reviews-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .reviews-table th, .reviews-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .reviews-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .reviews-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .review-rating {
            color: #f39c12;
            font-size: 1.2em;
        }
        
        .review-source {
            font-size: 0.9em;
            color: #999;
        }
        
        .review-comment {
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
        }
        
        .footer {
            text-align: center;
            padding: 20px 0;
            color: #aaa;
        }
        
        @media (max-width: 992px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-content">
            <div>
                <h1 id="businessNameHeader">Analytics Dashboard</h1>
                <p>An overview of your review performance.</p>
            </div>
            <div class="refresh-info">
                Last refreshed: <span id="lastUpdated">...</span>
            </div>
        </div>
    </header>

    <main class="container">
        
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Reviews</div>
                <div class="stat-number" id="totalReviewsStat">...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Average Rating</div>
                <div class="stat-number" id="avgRatingStat">...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Response Rate</div>
                <div class="stat-number" id="responseRateStat">...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Google Review Clicks</div>
                <div class="stat-number" id="googleClicksStat">...</div>
            </div>
        </section>

        <section class="charts-section">
            <div class="chart-card">
                <h3>Rating Breakdown</h3>
                <div class="chart-container">
                    <canvas id="ratingDistributionChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Reviews Over Time</h3>
                <div class="chart-container">
                    <canvas id="reviewTrendsChart"></canvas>
                </div>
            </div>
        </section>

        <section class="reviews-section">
            <div class="reviews-header">
                <h3>Recent Reviews</h3>
            </div>
            <div class="reviews-table-container">
                <table class="reviews-table">
                    <thead>
                        <tr>
                            <th>Rating</th>
                            <th>Customer</th>
                            <th>Source</th>
                            <th>Comment</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="reviewsTableBody">
                        </tbody>
                </table>
            </div>
        </section>

    </main>

    <footer class="footer">
        &copy; 2024 RevuMate. All rights reserved.
    </footer>

    <script>
        let ratingChart, trendsChart;
        let refreshInterval;

        document.addEventListener('DOMContentLoaded', () => {
            loadAnalyticsData();
            startAutoRefresh();
        });

        async function loadAnalyticsData() {
            const urlParams = new URLSearchParams(window.location.search);
            const clientId = urlParams.get('clientId');
            
            if (!clientId) {
                showNoData();
                return;
            }

            try {
                // Replace with your actual n8n webhook URL
                const webhookUrl = `YOUR_N8N_WEBHOOK_URL/client-dashboard-data?clientId=${clientId}`;

                const response = await fetch(webhookUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Update page elements with data
                updateTitleAndHeader(data.businessName, data.brandColor);
                updateStats(data.stats);
                createRatingChart(data.ratingDistribution);
                createTrendsChart(data.trends);
                populateReviewsTable(data.reviews);
                updateLastUpdated();

            } catch (error) {
                console.error("Could not fetch analytics data:", error);
                showNoData();
            }
        }
        
        function updateTitleAndHeader(businessName, brandColor) {
            document.title = `Analytics Dashboard - ${businessName}`;
            document.getElementById('businessNameHeader').textContent = businessName;
            if (brandColor) {
                document.documentElement.style.setProperty('--primary-color', brandColor);
            }
        }

        function updateStats(statsData) {
            document.getElementById('totalReviewsStat').textContent = statsData?.totalReviews || 0;
            document.getElementById('avgRatingStat').textContent = (statsData?.avgRating || 0).toFixed(1);
            document.getElementById('responseRateStat').textContent = `${statsData?.responseRate || 0}%`;
            document.getElementById('googleClicksStat').textContent = statsData?.googleClicks || 0;
        }

        function createRatingChart(distribution) {
            const ctx = document.getElementById('ratingDistributionChart').getContext('2d');
            
            if (ratingChart) {
                ratingChart.destroy();
            }
            
            ratingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
                    datasets: [{
                        label: 'Number of Reviews',
                        data: distribution,
                        backgroundColor: ['#e74c3c', '#e67e22', '#f1c40f', '#3498db', '#2ecc71'],
                        borderColor: 'rgba(0, 0, 0, 0)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Reviews'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Rating'
                            }
                        }
                    }
                }
            });
        }
        
        function createTrendsChart(trends) {
            const ctx = document.getElementById('reviewTrendsChart').getContext('2d');
            
            if (trendsChart) {
                trendsChart.destroy();
            }
            
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trends.months,
                    datasets: [{
                        label: 'Total Reviews',
                        data: trends.totalReviews,
                        borderColor: document.documentElement.style.getPropertyValue('--primary-color') || '#4CAF50',
                        tension: 0.3,
                        fill: false
                    }, {
                        label: 'Avg. Rating',
                        data: trends.avgRating,
                        borderColor: '#f39c12',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Reviews'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            max: 5,
                            title: {
                                display: true,
                                text: 'Average Rating'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        function populateReviewsTable(reviewsData) {
            const tableBody = document.getElementById('reviewsTableBody');
            tableBody.innerHTML = '';
            
            if (!reviewsData || reviewsData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 50px;">
                            <h3>No reviews found.</h3>
                            <p>Once you start getting reviews, they will appear here.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            reviewsData.forEach(review => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${'★'.repeat(review.rating)}</td>
                    <td>${review.customerName}</td>
                    <td><span class="review-source">${review.source}</span></td>
                    <td><span class="review-comment">${review.comment || 'N/A'}</span></td>
                    <td>${new Date(review.timestamp).toLocaleDateString()}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
        }

        function showNoData() {
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    <h1 style="color: #e74c3c;">Error: Client ID Not Found</h1>
                    <p style="color: #666;">Please ensure you are accessing this page with a valid client ID.</p>
                </div>
            `;
        }

        function startAutoRefresh() {
            let timeLeft = 15 * 60; // 15 minutes in seconds
            const refreshIntervalDisplay = document.getElementById('refreshIntervalDisplay');
            
            refreshInterval = setInterval(() => {
                timeLeft--;
                if (refreshIntervalDisplay) {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    refreshIntervalDisplay.textContent = `Auto-refresh in: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                }
                
                if (timeLeft <= 0) {
                    loadAnalyticsData();
                    timeLeft = 15 * 60; // Reset timer
                }
            }, 1000);
        }
        
        function exportData() {
            // Create CSV export
            const csvData = generateCSV();
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function generateCSV() {
            // This would generate CSV from the current data
            // For now, return a simple header
            return `Business Name,Export Date,Total Reviews,Average Rating,Response Rate,Google Review Clicks\n`;
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            if (ratingChart) ratingChart.destroy();
            if (trendsChart) trendsChart.destroy();
        });
    </script>
</body>
</html>