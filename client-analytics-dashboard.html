<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - {{businessName}}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color, #4CAF50) 0%, #45a049 100%);
            color: white;
            padding: 30px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .refresh-info {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 5px solid var(--primary-color, #4CAF50);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: var(--primary-color, #4CAF50);
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-change {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 20px;
            margin-top: 10px;
        }
        
        .stat-change.positive {
            background: #d4edda;
            color: #155724;
        }
        
        .stat-change.negative {
            background: #f8d7da;
            color: #721c24;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }
        
        .chart-card h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.4em;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .reviews-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .reviews-header {
            background: var(--primary-color, #4CAF50);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reviews-header h3 {
            font-size: 1.5em;
        }
        
        .reviews-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .review-item {
            padding: 25px 30px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s ease;
        }
        
        .review-item:hover {
            background: #f8f9fa;
        }
        
        .review-item:last-child {
            border-bottom: none;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .customer-name {
            font-weight: bold;
            color: #333;
        }
        
        .review-date {
            color: #666;
            font-size: 0.9em;
        }
        
        .rating-stars {
            color: #ffd700;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        .review-text {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .review-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .tag {
            background: #e9ecef;
            color: #495057;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
        }
        
        .tag.positive {
            background: #d4edda;
            color: #155724;
        }
        
        .tag.negative {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color, #4CAF50);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .no-data h3 {
            margin-bottom: 15px;
            color: #999;
        }
        
        .export-btn {
            background: var(--primary-color, #4CAF50);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        
        .export-btn:hover {
            background: #45a049;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .stat-number {
                font-size: 2.5em;
            }
            
            .review-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h1 id="businessName">Analytics Dashboard</h1>
                <p>Real-time insights into your customer feedback</p>
            </div>
            <div class="refresh-info">
                <span>üîÑ Auto-refresh: <span id="refreshTimer">15:00</span></span>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="stats-grid" id="statsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading analytics data...</p>
            </div>
        </div>
        
        <div class="charts-section" id="chartsSection" style="display: none;">
            <div class="chart-card">
                <h3>üìä Rating Distribution</h3>
                <div class="chart-container">
                    <canvas id="ratingChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>üìà Reviews Over Time</h3>
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="reviews-section" id="reviewsSection" style="display: none;">
            <div class="reviews-header">
                <h3>üí¨ Recent Reviews</h3>
                <button class="export-btn" onclick="exportData()">üì• Export Data</button>
            </div>
            <div class="reviews-list" id="reviewsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading recent reviews...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const businessName = urlParams.get('business') || 'Your Business';
        const clientId = urlParams.get('clientId') || '';
        const primaryColor = urlParams.get('color') || '#4CAF50';
        
        // Set CSS custom property for primary color
        // Updated for localhost n8n instance
        document.documentElement.style.setProperty('--primary-color', primaryColor);
        
        // Update business name
        document.getElementById('businessName').textContent = `${businessName} - Analytics`;
        document.title = `Analytics Dashboard - ${businessName}`;
        
        let refreshInterval;
        let ratingChart, trendsChart;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            loadAnalyticsData();
            startRefreshTimer();
        });
        
        async function loadAnalyticsData() {
            try {
                const response = await fetch(`http://localhost:5678/webhook/client-analytics/${clientId}`);
                const data = await response.json();
                
                if (data.error) {
                    showNoData();
                    return;
                }
                
                renderStats(data.stats);
                renderCharts(data.charts);
                renderRecentReviews(data.recentReviews);
                
                document.getElementById('chartsSection').style.display = 'grid';
                document.getElementById('reviewsSection').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                showNoData();
            }
        }
        
        function renderStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            
            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalReviews || 0}</div>
                    <div class="stat-label">Total Reviews</div>
                    <div class="stat-change ${stats.reviewsChange >= 0 ? 'positive' : 'negative'}">
                        ${stats.reviewsChange >= 0 ? '+' : ''}${stats.reviewsChange || 0}% this month
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number">${stats.averageRating || '0.0'}</div>
                    <div class="stat-label">Average Rating</div>
                    <div class="stat-change ${stats.ratingChange >= 0 ? 'positive' : 'negative'}">
                        ${stats.ratingChange >= 0 ? '+' : ''}${stats.ratingChange || 0.0} from last month
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number">${stats.responseRate || '0'}%</div>
                    <div class="stat-label">Response Rate</div>
                    <div class="stat-change ${stats.responseChange >= 0 ? 'positive' : 'negative'}">
                        ${stats.responseChange >= 0 ? '+' : ''}${stats.responseChange || 0}% this month
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number">${stats.googleReviewClicks || 0}</div>
                    <div class="stat-label">Google Review Clicks</div>
                    <div class="stat-change ${stats.clicksChange >= 0 ? 'positive' : 'negative'}">
                        ${stats.clicksChange >= 0 ? '+' : ''}${stats.clicksChange || 0}% this month
                    </div>
                </div>
            `;
            
            statsGrid.innerHTML = statsHTML;
        }
        
        function renderCharts(chartData) {
            // Rating Distribution Chart
            const ratingCtx = document.getElementById('ratingChart').getContext('2d');
            if (ratingChart) ratingChart.destroy();
            
            ratingChart = new Chart(ratingCtx, {
                type: 'doughnut',
                data: {
                    labels: ['5 Stars', '4 Stars', '3 Stars', '2 Stars', '1 Star'],
                    datasets: [{
                        data: chartData.ratingDistribution || [0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#28a745',
                            '#6f42c1',
                            '#ffc107',
                            '#fd7e14',
                            '#dc3545'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
            
            // Trends Chart
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            if (trendsChart) trendsChart.destroy();
            
            trendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: chartData.trendLabels || [],
                    datasets: [{
                        label: 'Reviews',
                        data: chartData.trendData || [],
                        borderColor: primaryColor,
                        backgroundColor: primaryColor + '20',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        function renderRecentReviews(reviews) {
            const reviewsList = document.getElementById('reviewsList');
            
            if (!reviews || reviews.length === 0) {
                reviewsList.innerHTML = `
                    <div class="no-data">
                        <h3>No reviews yet</h3>
                        <p>Reviews will appear here once customers start submitting feedback.</p>
                    </div>
                `;
                return;
            }
            
            const reviewsHTML = reviews.map(review => `
                <div class="review-item">
                    <div class="review-header">
                        <span class="customer-name">${review.customerName || 'Anonymous'}</span>
                        <span class="review-date">${formatDate(review.submissionTime)}</span>
                    </div>
                    <div class="rating-stars">${'‚≠ê'.repeat(review.rating || 0)}</div>
                    <div class="review-text">${review.feedback || 'No feedback provided'}</div>
                    ${review.suggestions ? `<div class="review-text"><strong>Suggestions:</strong> ${review.suggestions}</div>` : ''}
                    <div class="review-tags">
                        ${review.wouldRecommend === 'yes' ? '<span class="tag positive">Would Recommend</span>' : ''}
                        ${review.googleReviewClicked === 'true' ? '<span class="tag positive">Google Review Clicked</span>' : ''}
                        ${review.contactPreference && review.contactPreference !== 'none' ? `<span class="tag">Contact: ${review.contactPreference}</span>` : ''}
                    </div>
                </div>
            `).join('');
            
            reviewsList.innerHTML = reviewsHTML;
        }
        
        function showNoData() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="no-data" style="grid-column: 1 / -1;">
                    <h3>No data available</h3>
                    <p>Analytics will appear here once you start receiving customer feedback.</p>
                </div>
            `;
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        function startRefreshTimer() {
            let timeLeft = 15 * 60; // 15 minutes in seconds
            
            refreshInterval = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('refreshTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    loadAnalyticsData();
                    timeLeft = 15 * 60; // Reset timer
                }
            }, 1000);
        }
        
        function exportData() {
            // Create CSV export
            const csvData = generateCSV();
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${businessName.replace(/\s+/g, '_')}_analytics_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function generateCSV() {
            // This would generate CSV from the current data
            // For now, return a simple header
            return `Business Name,Export Date,Total Reviews,Average Rating,Response Rate,Google Review Clicks
${businessName},${new Date().toISOString()},0,0.0,0%,0`;
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            if (ratingChart) ratingChart.destroy();
            if (trendsChart) trendsChart.destroy();
        });
    </script>
</body>
</html>
